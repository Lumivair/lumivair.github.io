<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timetable Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root {
            /* KDE Plasma / Breeze Light */
            --bg-body: #eff0f1;
            --bg-card: #ffffff;
            --text-main: #232629;
            --text-sub: #4d5c6d;
            --border: #d3dae3;
            --accent-blue: #3daee9;
            --accent-red: #da4453;
            --accent-orange: #f67400;
            --accent-green: #27ae60;
            --slot-bg: #fcfcfc;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Breeze Dark */
                --bg-body: #1a1e24;
                --bg-card: #2a2e34;
                --text-main: #fcfcfc;
                --text-sub: #bdc3c7;
                --border: #3f4752;
                --slot-bg: #31363b;
            }
        }

        body {
            font-family: "Noto Sans", sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        /* --- Header --- */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        .sync-status { font-size: 0.85em; color: var(--text-sub); font-family: monospace; }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--bg-card);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .navigation button {
            padding: 8px 16px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-body);
            color: var(--text-main);
            border-radius: 2px;
        }
        .navigation button:hover { background: var(--accent-blue); color: white; }

        /* --- Desktop Grid --- */
        .desktop-grid {
            display: none;
            grid-template-columns: 60px repeat(5, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        .grid-header { background: var(--bg-card); padding: 10px; text-align: center; font-weight: bold; }
        .time-col {
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.75em;
            text-align: center;
            color: var(--text-sub);
        }
        .day-column { background: var(--bg-body); position: relative; min-height: 700px; }

        /* --- Cards --- */
        .lesson-card {
            background: var(--slot-bg);
            padding: 8px;
            border-left: 4px solid var(--accent-blue);
            font-size: 0.85em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: absolute;
            left: 2px; right: 2px;
            border-radius: 2px;
        }
        .status-cancelled { background: rgba(218, 68, 83, 0.1); border-left-color: var(--accent-red); }
        .status-cancelled .title { text-decoration: line-through; }
        .status-substitution { background: rgba(246, 116, 0, 0.1); border-left-color: var(--accent-orange); }
        .status-event {
            position: absolute; top:0; bottom:0; left:0; right:0;
            background: var(--bg-card); border-left: 5px solid var(--accent-green);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }

        .room-changed { color: var(--accent-red); font-weight: bold; }
        .msg { font-weight: bold; font-size: 0.8em; margin-top: 4px; display: block; }

        /* --- Mobile List --- */
        .mobile-list { display: block; }
        .day-group { margin-bottom: 20px; }
        .day-title { font-weight: bold; border-bottom: 1px solid var(--border); margin-bottom: 10px; padding-bottom: 5px; }
        .mobile-entry {
            display: flex; background: var(--bg-card); margin-bottom: 5px;
            border: 1px solid var(--border); border-left: 5px solid var(--accent-blue);
        }
        .m-time { width: 60px; padding: 10px; font-size: 0.75em; border-right: 1px solid var(--border); text-align: center; }
        .m-content { padding: 10px; flex: 1; }

        @media (min-width: 800px) {
            .mobile-list { display: none; }
            .desktop-grid { display: grid; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>üóìÔ∏è Timetable</h1>
        <div class="sync-status" id="sync-timer">Checking sync status...</div>
    </div>

    <div class="navigation">
        <button onclick="changeWeek(-1)">‚Üê Prev</button>
        <h3 id="current-week-display" style="margin: 0;"></h3>
        <button onclick="changeWeek(1)">Next ‚Üí</button>
    </div>

    <div id="mobile-output" class="mobile-list"></div>

    <div id="desktop-output" class="desktop-grid">
        <div class="grid-header">Time</div>
        <div class="grid-header">Mon</div><div class="grid-header">Tue</div><div class="grid-header">Wed</div><div class="grid-header">Thu</div><div class="grid-header">Fri</div>
        <div class="time-col">
            <span>07:45</span><span>09:00</span><span>10:30</span><span>12:00</span><span>13:30</span><span>15:00</span><span>16:30</span><span>18:00</span>
        </div>
        <div class="day-column" id="day-0"></div><div class="day-column" id="day-1"></div><div class="day-column" id="day-2"></div><div class="day-column" id="day-3"></div><div class="day-column" id="day-4"></div>
    </div>

    <script>
        const API_BASE = 'https://timetable.lumivair.space';
        const weekCache = {};
        let currentViewDate = moment().startOf('isoWeek');
        let lastSyncTimestamp = 0;

        const GRID_START = 7 * 60 + 45;
        const PX_PER_MIN = 1.3;

        async function fetchWeekData(year, week) {
            const cacheKey = `${year}-${week}`;
            if (weekCache[cacheKey]) return weekCache[cacheKey];
            try {
                const response = await fetch(`${API_BASE}/week/${year}/${week}`);
                const data = await response.json();
                weekCache[cacheKey] = data;
                return data;
            } catch (error) { return []; }
        }

        async function updateSyncStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                lastSyncTimestamp = data.last_sync_ts;
                renderSyncTime();
            } catch (e) {}
        }

        function renderSyncTime() {
            const el = document.getElementById('sync-timer');
            if (!lastSyncTimestamp) return;
            const diff = moment().diff(moment.unix(lastSyncTimestamp), 'minutes');
            el.textContent = diff < 1 ? "Synced: Just now" : `Synced: ${diff} min ago`;
            el.style.color = diff > 60 ? 'var(--accent-red)' : 'var(--text-sub)';
        }

        async function renderTimetable() {
            const mobileOut = document.getElementById('mobile-output');
            const dayCols = [0,1,2,3,4].map(i => document.getElementById(`day-${i}`));
            const year = currentViewDate.isoWeekYear();
            const week = currentViewDate.isoWeek();

            document.getElementById('current-week-display').textContent = `Week ${week} (${currentViewDate.format('D.M')} - ${currentViewDate.clone().endOf('isoWeek').format('D.M')})`;

            mobileOut.innerHTML = 'Loading...';
            dayCols.forEach(c => c.innerHTML = '');

            const lessons = await fetchWeekData(year, week);
            mobileOut.innerHTML = '';

            const days = [];
            for(let i=0; i<5; i++) days.push(currentViewDate.clone().add(i, 'days').format('YYYY-MM-DD'));

            days.forEach((date, idx) => {
                const dayLessons = lessons.filter(l => l.lessonDate === date);
                const blocker = dayLessons.find(l => l.isFullDay || l.timetableEntryTypeLong === 'block substitution' || l.lessonStart === "00:00:00");

                // Mobile
                const group = document.createElement('div');
                group.className = 'day-group';
                group.innerHTML = `<div class="day-title">${moment(date).format('dddd, D. MMMM')}</div>`;

                if (blocker) {
                    group.innerHTML += `
                        <div class="mobile-entry" style="border-left-color: var(--accent-green)">
                            <div class="m-time">DAY</div>
                            <div class="m-content"><b>${blocker.title}</b><br>${blocker.message || ''}</div>
                        </div>`;
                } else {
                    dayLessons.forEach(l => {
                        const isCancel = l.isCancelled || l.timetableEntryTypeLong?.includes('cancel');
                        const isSub = l.timetableEntryType === 'substitution';
                        const border = isCancel ? 'var(--accent-red)' : (isSub ? 'var(--accent-orange)' : 'var(--accent-blue)');
                        group.innerHTML += `
                            <div class="mobile-entry" style="border-left-color: ${border}">
                                <div class="m-time">${l.lessonStart.slice(0,5)}<br>${l.lessonEnd.slice(0,5)}</div>
                                <div class="m-content">
                                    <span class="title" style="${isCancel ? 'text-decoration:line-through' : ''}"><b>${l.title}</b></span>
                                    <br><small>${l.teacherAcronym} | ${l.roomName}</small>
                                    ${l.message ? `<br><span class="msg" style="color:${border}">${l.message}</span>` : ''}
                                </div>
                            </div>`;
                    });
                }
                mobileOut.appendChild(group);

                // Desktop
                const col = dayCols[idx];
                if (blocker) {
                    col.innerHTML = `<div class="status-event"><b>${blocker.title}</b><p>${blocker.message || ''}</p></div>`;
                } else {
                    dayLessons.forEach(l => {
                        const start = moment(l.lessonStart, "HH:mm:ss").diff(moment(l.lessonStart, "HH:mm:ss").startOf('day'), 'minutes');
                        const end = moment(l.lessonEnd, "HH:mm:ss").diff(moment(l.lessonEnd, "HH:mm:ss").startOf('day'), 'minutes');
                        const card = document.createElement('div');
                        card.className = 'lesson-card';
                        if (l.isCancelled || l.timetableEntryTypeLong?.includes('cancel')) card.classList.add('status-cancelled');
                        else if (l.timetableEntryType === 'substitution') card.classList.add('status-substitution');

                        card.style.top = `${(start - GRID_START) * PX_PER_MIN}px`;
                        card.style.height = `${(end - start) * PX_PER_MIN}px`;
                        card.innerHTML = `<b>${l.title}</b><br>${l.teacherAcronym} <span class="${l.isRoomChanged ? 'room-changed' : ''}">${l.roomName}</span>`;
                        if (l.message) card.innerHTML += `<span class="msg">${l.message}</span>`;
                        col.appendChild(card);
                    });
                }
            });
        }

        window.changeWeek = delta => { currentViewDate.add(delta, 'weeks'); renderTimetable(); };
        updateSyncStatus();
        renderTimetable();
        setInterval(renderSyncTime, 60000);
        setInterval(updateSyncStatus, 300000);
    </script>
</body>
</html>
