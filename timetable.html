<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Timetable Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .navigation { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .navigation button { padding: 10px 15px; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; border-radius: 4px; }
        /* Added focus style for better accessibility */
        .navigation button:focus { outline: 2px solid #007bff; }
        .lesson-entry { margin-bottom: 15px; padding: 10px; border-left: 5px solid #007bff; background: #e9f7ff; border-radius: 4px; }
        .lesson-title { font-weight: bold; margin-bottom: 5px; }
        .lesson-details { font-size: 0.9em; color: #555; }
    </style>
</head>
<body>

    <header>
        <h1>üóìÔ∏è Timetable Viewer</h1>
    </header>

    <div class="navigation">
        <button onclick="window.changeWeek(-1)">‚Üê Previous Week</button>
        <h2 id="current-week-display"></h2>
        <button onclick="window.changeWeek(1)">Next Week ‚Üí</button>
    </div>

    <div id="timetable-output">
        <p>Loading timetable data...</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'https://timetable.lumivair.space/timetable/latest'; 
        
        let allTimetableData = [];
        // Use Monday as the start of the week for European standard
        let currentWeekStart = moment().startOf('isoWeek'); 

        // --- Data Fetching ---
        // Make fetchTimetableData a global function by attaching it to window, 
        // though in this simple script it's generally fine as is.
        async function fetchTimetableData() {
            try {
                const outputDiv = document.getElementById('timetable-output');
                outputDiv.innerHTML = '<p>Fetching data...</p>'; // Show status

                const response = await fetch(API_URL);
                
                if (response.status === 304) {
                    console.log("Timetable data unchanged (304 Not Modified). Rendering from cache.");
                    if (allTimetableData.length > 0) {
                        renderTimetable();
                        return;
                    }
                    throw new Error("Received 304, but no data was previously loaded. Try clearing cache.");
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                allTimetableData = await response.json();
                
                if (allTimetableData.length === 0) {
                    outputDiv.innerHTML = 
                        '<p>Timetable data loaded but is empty. Check the backend script date range.</p>';
                    return;
                }

                console.log("Timetable data successfully fetched (200 OK) and parsed.");
                renderTimetable();
                
            } catch (error) {
                console.error("Could not fetch or parse timetable data:", error);
                document.getElementById('timetable-output').innerHTML = 
                    `<p style="color: red;">Error loading data: ${error.message}. Check browser console for details. (Note: The API URL may be inaccessible outside its intended network.)</p>`;
            }
        }

        // --- Rendering Logic ---
        function renderTimetable() {
            const outputDiv = document.getElementById('timetable-output');
            outputDiv.innerHTML = ''; 

            // Calculate the current week range (inclusive)
            const weekStart = currentWeekStart.clone().startOf('isoWeek');
            const weekEnd = currentWeekStart.clone().endOf('isoWeek');

            // Update the display title
            document.getElementById('current-week-display').textContent = 
                `Week ${weekStart.isoWeek()} (${weekStart.format('MMM D')} - ${weekEnd.format('MMM D, YYYY')})`;

            // Filter lessons for the selected week
            const weeklyLessons = allTimetableData.filter(lesson => {
                // Ensure lessonDate is handled as a start of day moment object for reliable comparison
                const lessonDate = moment(lesson.lessonDate, 'YYYY-MM-DD').startOf('day'); 
                // Use isBetween with '[]' for inclusive start and end dates
                return lessonDate.isBetween(weekStart.startOf('day'), weekEnd.startOf('day'), null, '[]'); 
            });

            if (weeklyLessons.length === 0) {
                outputDiv.innerHTML = '<p>No lessons found for this week.</p>';
                return;
            }

            // Group lessons by day (key is "Monday, 2025-11-28")
            const lessonsByDay = weeklyLessons.reduce((acc, lesson) => {
                const day = moment(lesson.lessonDate, 'YYYY-MM-DD').format('dddd, YYYY-MM-DD');
                acc[day] = acc[day] || [];
                acc[day].push(lesson);
                return acc;
            }, {});

            // Render the daily view, sorted by day order
            Object.keys(lessonsByDay).sort((a, b) => moment(a, 'dddd, YYYY-MM-DD').valueOf() - moment(b, 'dddd, YYYY-MM-DD').valueOf()).forEach(day => {
                const dayHeader = document.createElement('h3');
                // Use a cleaner format for the display
                dayHeader.textContent = moment(day, 'dddd, YYYY-MM-DD').format('dddd, MMMM Do'); 
                outputDiv.appendChild(dayHeader);

                // Sort lessons within the day by start time (using sort_key for reliability)
                lessonsByDay[day].sort((a, b) => a.sort_key.localeCompare(b.sort_key)).forEach(lesson => {
                    const lessonElement = document.createElement('div');
                    lessonElement.className = 'lesson-entry';
                    
                    const time = `${lesson.lessonStart.substring(0, 5)} - ${lesson.lessonEnd.substring(0, 5)}`;
                    const title = lesson.title || lesson.subjectName || 'Lesson';
                    // Better room handling
                    const room = lesson.roomName ? ` | Room: ${lesson.roomName}` : ''; 
                    const teacher = lesson.teacherAcronym || (Array.isArray(lesson.teacherFullName) ? lesson.teacherFullName.join(', ') : lesson.teacherFullName) || 'N/A';
                    const course = lesson.course || 'N/A';
                    const type = lesson.timetableEntryType === 'substitution' ? ' **(Substitution)**' : '';

                    lessonElement.innerHTML = `
                        <p class="lesson-title">${time} &mdash; ${title}${type}</p>
                        <p class="lesson-details">Course: ${course} | Teacher: ${teacher}${room}</p>
                    `;
                    outputDiv.appendChild(lessonElement);
                });
            });
        }

        // --- Navigation Logic ---
        // Exposing changeWeek globally for the HTML onclick handlers
        window.changeWeek = function(direction) {
            // Use isoWeek to ensure the week starts on Monday consistently
            currentWeekStart.add(direction, 'weeks').startOf('isoWeek');
            renderTimetable();
        }
        
        // Initial load
        window.onload = fetchTimetableData; // Or simply call it outside a function, as was done originally
        fetchTimetableData(); 
    </script>

</body>
</html>
